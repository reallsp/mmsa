# COPA 1231 æ•°æ®é›†è®­ç»ƒå’Œæµ‹è¯•æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—è¯´æ˜å¦‚ä½•ä½¿ç”¨ MMSA æ¡†æ¶å¯¹ `copa_1231` æ•°æ®é›†è¿›è¡Œè®­ç»ƒå’Œæµ‹è¯•ã€‚

---

## ğŸ”„ å®Œæ•´æµç¨‹

### æ­¥éª¤ 1: æ•°æ®å‡†å¤‡

ç¡®ä¿æ•°æ®æ–‡ä»¶å·²è½¬æ¢å¹¶å‡†å¤‡å¥½ï¼š

```bash
# æ£€æŸ¥æ•°æ®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls /root/autodl-tmp/data/copa_1231_converted.pkl
```

å¦‚æœæ•°æ®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œéœ€è¦å…ˆè¿è¡Œæ•°æ®è½¬æ¢è„šæœ¬ï¼š

```bash
cd /root/autodl-tmp/code/mmsa
python3 convert_copa_data.py
```

**æ•°æ®æ–‡ä»¶è¦æ±‚**ï¼š
- è®­ç»ƒé›†ï¼š`/root/autodl-tmp/data/copa_train_1231.pkl`
- æµ‹è¯•é›†ï¼š`/root/autodl-tmp/data/copa_test_1231.pkl`
- è½¬æ¢åè¾“å‡ºï¼š`/root/autodl-tmp/data/copa_1231_converted.pkl`

---

### æ­¥éª¤ 2: è®­ç»ƒæ¨¡å‹

#### æ–¹å¼ 1: ä½¿ç”¨ GPU è®­ç»ƒï¼ˆæ¨èï¼‰

```bash
cd /root/autodl-tmp/code/mmsa

# ä¿®æ”¹ train_gpu.py ä¸­çš„æ•°æ®é›†åç§°
# å°† dataset_name='custom' æ”¹ä¸º dataset_name='copa_1231'

python3 train_gpu.py
```

**æˆ–è€…ç›´æ¥ä½¿ç”¨ Python API**ï¼š

```python
from MMSA.run import MMSA_run

results = MMSA_run(
    model_name='tfn',
    dataset_name='copa_1231',
    seeds=[1111],
    gpu_ids=[0],
    num_workers=4,
    verbose_level=1,
    skip_validation=True,  # è·³è¿‡éªŒè¯é›†æµç¨‹
    model_save_dir="./saved_models",
    res_save_dir="./results",
    log_dir="./logs"
)
```

#### æ–¹å¼ 2: ä½¿ç”¨ CPU è®­ç»ƒ

```bash
cd /root/autodl-tmp/code/mmsa

# ä¿®æ”¹ train_cpu.py ä¸­çš„æ•°æ®é›†åç§°
# å°† dataset_name='custom' æ”¹ä¸º dataset_name='copa_1231'

python3 train_cpu.py
```

---

### æ­¥éª¤ 3: æŸ¥çœ‹è®­ç»ƒç»“æœ

è®­ç»ƒå®Œæˆåï¼Œç»“æœä¼šä¿å­˜åœ¨ä»¥ä¸‹ä½ç½®ï¼š

1. **æ¨¡å‹æ–‡ä»¶**ï¼š
   ```
   saved_models/tfn-copa_1231.pth
   ```

2. **æµ‹è¯•ç»“æœ CSV**ï¼š
   ```
   results/normal/copa_1231.csv
   ```
   åŒ…å«æ‰€æœ‰è¯„ä¼°æŒ‡æ ‡ï¼ŒåŒ…æ‹¬ï¼š
   - åŸºç¡€æŒ‡æ ‡ï¼šå‡†ç¡®ç‡ã€F1åˆ†æ•°ã€MAEã€ç›¸å…³ç³»æ•°ç­‰
   - **COPA æŒ‡æ ‡**ï¼šæ•´ä½“å‡†ç¡®ç‡å’Œå„èŒƒå¼å‡†ç¡®ç‡ï¼ˆP1-P12ï¼‰

3. **è®­ç»ƒæ—¥å¿—**ï¼š
   ```
   logs/tfn-copa_1231.log
   ```

---

## ğŸ“Š è¯„ä¼°æŒ‡æ ‡è¯´æ˜

### åŸºç¡€æŒ‡æ ‡

- **åŒ…å«0çš„äºŒåˆ†ç±»å‡†ç¡®ç‡**ï¼šåŒ…å«ä¸­æ€§æ ·æœ¬çš„äºŒåˆ†ç±»å‡†ç¡®ç‡
- **ä¸åŒ…å«0çš„äºŒåˆ†ç±»å‡†ç¡®ç‡**ï¼šæ’é™¤ä¸­æ€§æ ·æœ¬çš„äºŒåˆ†ç±»å‡†ç¡®ç‡
- **5çº§å¤šåˆ†ç±»å‡†ç¡®ç‡**ï¼šå°†å›å½’å€¼æ˜ å°„åˆ°5ä¸ªç­‰çº§åçš„å‡†ç¡®ç‡
- **7çº§å¤šåˆ†ç±»å‡†ç¡®ç‡**ï¼šå°†å›å½’å€¼æ˜ å°„åˆ°7ä¸ªç­‰çº§åçš„å‡†ç¡®ç‡
- **MAE**ï¼šå¹³å‡ç»å¯¹è¯¯å·®
- **ç›¸å…³ç³»æ•°**ï¼šé¢„æµ‹å€¼ä¸çœŸå®å€¼çš„ç›¸å…³ç³»æ•°

### COPA æŒ‡æ ‡

- **COPAæ•´ä½“å‡†ç¡®ç‡**ï¼šæ‰€æœ‰èŒƒå¼çš„æ•´ä½“å‡†ç¡®ç‡
- **COPA_P1~P12å‡†ç¡®ç‡**ï¼š12ä¸ªå¿ƒç†èŒƒå¼çš„å•ç‹¬å‡†ç¡®ç‡

COPA æŒ‡æ ‡åŸºäºå¿ƒç†å­¦å¸¸æ¨¡è½¬æ¢ï¼Œå°†é¢„æµ‹å€¼è½¬æ¢ä¸º T åˆ†æ•°ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦åœ¨æ­£ç¡®çš„ç­‰çº§èŒƒå›´å†…ã€‚

---

## ğŸ”§ é…ç½®è¯´æ˜

### æ•°æ®é›†é…ç½®

é…ç½®æ–‡ä»¶ä½ç½®ï¼š`src/MMSA/config/config_regression.json`

`copa_1231` æ•°æ®é›†çš„é…ç½®ï¼š

```json
"copa_1231": {
  "unaligned": {
    "featurePath": "/root/autodl-tmp/data/copa_{mode}_1231_converted.pkl",
    "seq_lens": [50, 512, 197],
    "feature_dims": [768, 13, 768],
    "train_samples": 12200,
    "num_classes": 2,
    "language": "cn",
    "KeyEval": "Loss"
  }
}
```

### æ¨¡å‹é…ç½®

TFN æ¨¡å‹åœ¨ `copa_1231` æ•°æ®é›†ä¸Šçš„é…ç½®ï¼š

```json
"copa_1231": {
  "hidden_dims": [128, 32, 128],
  "text_out": 32,
  "post_fusion_dim": 64,
  "dropouts": [0.3, 0.3, 0.3, 0.5],
  "batch_size": 32,
  "learning_rate": 0.001
}
```

### è‡ªå®šä¹‰é…ç½®

å¦‚æœéœ€è¦ä¿®æ”¹è¶…å‚æ•°ï¼Œå¯ä»¥åœ¨è®­ç»ƒè„šæœ¬ä¸­ä¼ å…¥ `config` å‚æ•°ï¼š

```python
custom_config = {
    'batch_size': 16,      # å‡å°æ‰¹æ¬¡å¤§å°
    'learning_rate': 0.0005,  # è°ƒæ•´å­¦ä¹ ç‡
    'early_stop': 10,      # è°ƒæ•´æ—©åœè½®æ•°
}

results = MMSA_run(
    model_name='tfn',
    dataset_name='copa_1231',
    config=custom_config,
    ...
)
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹ç¤ºä¾‹

### ç¤ºä¾‹ 1: åŸºæœ¬è®­ç»ƒå’Œæµ‹è¯•

```bash
cd /root/autodl-tmp/code/mmsa

# 1. ç¡®ä¿æ•°æ®å·²è½¬æ¢
python3 convert_copa_data.py

# 2. è®­ç»ƒæ¨¡å‹ï¼ˆGPUï¼‰
python3 train_gpu.py  # éœ€è¦å…ˆä¿®æ”¹æ•°æ®é›†åç§°ä¸º copa_1231

# 3. æŸ¥çœ‹ç»“æœ
cat results/normal/copa_1231.csv
```

### ç¤ºä¾‹ 2: ä½¿ç”¨ Python API

```python
import sys
sys.path.insert(0, 'src')

from MMSA.run import MMSA_run
from pathlib import Path

# è®­ç»ƒå’Œæµ‹è¯•
results = MMSA_run(
    model_name='tfn',
    dataset_name='copa_1231',
    seeds=[1111, 1112, 1113],  # ä½¿ç”¨å¤šä¸ªéšæœºç§å­
    gpu_ids=[0],
    skip_validation=True,  # è·³è¿‡éªŒè¯é›†
    model_save_dir="./saved_models",
    res_save_dir="./results",
    log_dir="./logs"
)

print("è®­ç»ƒå®Œæˆï¼ç»“æœå·²ä¿å­˜åˆ° results/normal/copa_1231.csv")
```

---

## ğŸ“ é‡è¦è¯´æ˜

### 1. è·³è¿‡éªŒè¯é›†

å½“å‰æµç¨‹å·²é…ç½®ä¸º**è·³è¿‡éªŒè¯é›†**ï¼Œç›´æ¥ä½¿ç”¨è®­ç»ƒé›†è®­ç»ƒï¼Œæµ‹è¯•é›†æµ‹è¯•ã€‚è¿™æ˜¯é€šè¿‡ `skip_validation=True` å‚æ•°å®ç°çš„ã€‚

### 2. æ•°æ®æ ¼å¼

- è®­ç»ƒé›†å’Œæµ‹è¯•é›†éœ€è¦åˆ†åˆ«è½¬æ¢ä¸º MMSA æ ¼å¼
- è½¬æ¢åçš„æ–‡ä»¶åº”åŒ…å« `train`ã€`valid`ã€`test` ä¸‰ä¸ªé”®ï¼ˆå³ä½¿ä¸ä½¿ç”¨ validï¼‰
- æ•°æ®æ ¼å¼ï¼š`{train: {...}, valid: {...}, test: {...}}`

### 3. COPA æŒ‡æ ‡

COPA æŒ‡æ ‡ä¼šè‡ªåŠ¨è®¡ç®—å¹¶åŒ…å«åœ¨ç»“æœä¸­ï¼Œå‰ææ˜¯ï¼š
- æ•°æ®é›†åç§°ä¸º `copa_1231`
- æµ‹è¯•é›†æ ·æœ¬æŒ‰ç»„æ’åˆ—ï¼ˆæ¯ç»„122ä¸ªæ ·æœ¬ï¼‰
- æ¯ä¸ªç»„åŒ…å«12ä¸ªèŒƒå¼çš„æ•°æ®

### 4. æ¨¡å‹ä¿å­˜

è®­ç»ƒå®Œæˆåï¼Œæœ€ä½³æ¨¡å‹ä¼šè‡ªåŠ¨ä¿å­˜åˆ°ï¼š
```
saved_models/tfn-copa_1231.pth
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: æ‰¾ä¸åˆ°æ•°æ®æ–‡ä»¶

**é”™è¯¯**ï¼š`FileNotFoundError: copa_1231_converted.pkl`

**è§£å†³**ï¼š
```bash
# è¿è¡Œæ•°æ®è½¬æ¢è„šæœ¬
python3 convert_copa_data.py
```

### é—®é¢˜ 2: COPA æŒ‡æ ‡æœªå‡ºç°

**æ£€æŸ¥**ï¼š
1. ç¡®è®¤æ•°æ®é›†åç§°ä¸º `copa_1231`ï¼ˆä¸æ˜¯ `custom`ï¼‰
2. æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰ "COPAè¯„ä¼°å¤±è´¥" çš„è­¦å‘Š
3. ç¡®è®¤æµ‹è¯•é›†æ ·æœ¬æ•°èƒ½è¢« 122 æ•´é™¤ï¼ˆæ¯ç»„122ä¸ªæ ·æœ¬ï¼‰

### é—®é¢˜ 3: GPU å†…å­˜ä¸è¶³

**è§£å†³**ï¼š
- å‡å° `batch_size`ï¼ˆåœ¨é…ç½®ä¸­ä¿®æ”¹ï¼‰
- ä½¿ç”¨ CPU è®­ç»ƒï¼š`python3 train_cpu.py`

### é—®é¢˜ 4: è®­ç»ƒé€Ÿåº¦æ…¢

**ä¼˜åŒ–**ï¼š
- å¢åŠ  `num_workers`ï¼ˆGPU æ¨¡å¼å»ºè®® 4-8ï¼‰
- ä½¿ç”¨ GPU è®­ç»ƒ
- å‡å° `batch_size` å¦‚æœå†…å­˜å…è®¸ï¼Œå¯ä»¥å¢å¤§ä»¥åŠ å¿«è®­ç»ƒ

---

## ğŸ“‚ æ–‡ä»¶ç»“æ„

```
mmsa/
â”œâ”€â”€ convert_copa_data.py      # æ•°æ®è½¬æ¢è„šæœ¬
â”œâ”€â”€ train_gpu.py              # GPUè®­ç»ƒè„šæœ¬
â”œâ”€â”€ train_cpu.py              # CPUè®­ç»ƒè„šæœ¬
â”œâ”€â”€ train_custom.py           # è‡ªå®šä¹‰è®­ç»ƒè„šæœ¬
â”œâ”€â”€ saved_models/             # ä¿å­˜çš„æ¨¡å‹
â”‚   â””â”€â”€ tfn-copa_1231.pth
â”œâ”€â”€ results/                   # æµ‹è¯•ç»“æœ
â”‚   â””â”€â”€ normal/
â”‚       â””â”€â”€ copa_1231.csv
â””â”€â”€ logs/                      # è®­ç»ƒæ—¥å¿—
    â””â”€â”€ tfn-copa_1231.log
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

è®­ç»ƒå®Œæˆåï¼Œä½ å¯ä»¥ï¼š

1. **æŸ¥çœ‹è¯¦ç»†ç»“æœ**ï¼šæ‰“å¼€ `results/normal/copa_1231.csv`
2. **åˆ†æ COPA æŒ‡æ ‡**ï¼šæŸ¥çœ‹å„èŒƒå¼çš„å‡†ç¡®ç‡è¡¨ç°
3. **è°ƒæ•´è¶…å‚æ•°**ï¼šæ ¹æ®ç»“æœä¼˜åŒ–æ¨¡å‹é…ç½®
4. **å°è¯•å…¶ä»–æ¨¡å‹**ï¼šä¿®æ”¹ `model_name` å‚æ•°ï¼ˆå¦‚ `lmf`, `mfn` ç­‰ï¼‰

---

**æœ€åæ›´æ–°**: 2025-01-03

