# train_12.16_1.pkl 数据集适配方案

## 一、数据集格式分析

### 1.1 当前数据集格式
- **格式**: 列表（366个样本）
- **样本结构**:
  ```python
  {
      'text': (768,) float32,           # BERT特征向量
      'audio_waveform': (48208,) float32, # 音频波形（需要提取特征）
      'video_feature': (197, 768) float32, # 视频特征序列
      'ir_feature': (197, 768) float32,   # 红外特征序列
      'label': 0.0/1.0,                  # 二分类标签
      'bio': (4, 3) float64,             # 生物特征（可选）
      'eye': (48, 2) float64,            # 眼动特征（可选）
      'eeg': (14, 8) float64,            # 脑电特征（可选）
      'eda': (675, 7) float64,           # 皮肤电特征（可选）
  }
  ```

### 1.2 MMSA框架期望格式
```python
{
    'train': {
        'text_bert': [N, 3, seq_len] or 'text': [N, seq_len, dim],
        'audio': [N, seq_len, dim],
        'vision': [N, seq_len, dim],
        'id': [str, ...],
        'raw_text': [str, ...],
        'regression_labels': [N],
        'audio_lengths': [int, ...],
        'vision_lengths': [int, ...],
    },
    'valid': {...},
    'test': {...}
}
```

## 二、适配工作清单

### 工作1: 数据格式转换脚本 ✅ 优先级：🔴 高
**任务**: 创建转换脚本，将列表格式转换为MMSA期望的字典格式

**需要处理的内容**:
1. 数据集划分（train/valid/test，建议 70%/15%/15%）
2. 文本特征转换：768维向量 → text_bert格式 [3, seq_len]
3. 音频特征提取：波形 → MFCC特征序列
4. 视觉特征选择：使用video_feature作为vision
5. 标签转换：0.0/1.0 → regression_labels（-1.0/1.0）
6. 生成辅助字段：id, raw_text, lengths

**文件**: `convert_train_data.py`

### 工作2: 扩展数据加载器 ✅ 优先级：🔴 高
**任务**: 在MMDataset中添加新数据集支持

**修改文件**: `src/MMSA/data_loader.py`

**具体修改**:
1. 在DATASET_MAP中添加新数据集名称（如'custom'或'train_12_16'）
2. 添加`__init_custom()`方法，加载转换后的数据
3. 处理特征维度设置

### 工作3: 配置数据集参数 ✅ 优先级：🟡 中
**任务**: 在配置文件中添加新数据集配置

**修改文件**: `src/MMSA/config/config_regression.json`

**需要配置的参数**:
- featurePath: 转换后的pkl文件路径
- seq_lens: [文本序列长度, 音频序列长度, 视觉序列长度]
- feature_dims: [文本维度, 音频维度, 视觉维度]
- train_samples: 训练集样本数
- num_classes: 类别数（2或3）
- language: 语言（根据实际情况）
- KeyEval: 评估指标

### 工作4: 更新数据集支持列表 ✅ 优先级：🟡 中
**任务**: 在相关文件中添加新数据集到支持列表

**修改文件**:
- `src/MMSA/run.py`: SUPPORTED_DATASETS
- `src/MMSA/__main__.py`: argparse choices

## 三、实施步骤

### 步骤1: 创建数据转换脚本
```bash
python convert_train_data.py
```

### 步骤2: 修改数据加载器
在`data_loader.py`中添加新数据集初始化方法

### 步骤3: 更新配置文件
在`config_regression.json`中添加新数据集配置

### 步骤4: 测试数据加载
验证数据能否正确加载

### 步骤5: 运行模型训练
使用新数据集训练模型

## 四、注意事项

1. **特征维度**: 需要根据实际提取的特征确定维度
   - 文本: 768 (BERT) 或转换后的序列长度
   - 音频: MFCC特征维度（通常13或更高）
   - 视觉: 768 (video_feature的最后一维)

2. **序列长度**: 需要对齐到固定长度或使用unaligned模式
   - 文本: 需要确定合适的序列长度（如50）
   - 音频: 根据MFCC提取结果确定
   - 视觉: 197（video_feature的第一维）

3. **标签格式**: 
   - regression_labels: 连续值（-1.0到1.0）
   - 如果需要分类，可以添加classification_labels

4. **数据划分**: 建议使用分层划分保持标签分布

